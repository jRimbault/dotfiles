#!/usr/bin/env python3
"""Get the visible repositories for a given GitHub user or organization"""

import argparse
import json
import os
import re
import sys
from types import SimpleNamespace
from urllib.error import HTTPError
from urllib.request import Request, urlopen

def main(args):
    token = os.environ.get("GITHUB_API_TOKEN")
    if token:
        fetcher = get_all_repositories_graphql(args.user, token)
    else:
        fetcher = get_all_repositories_rest(args.user)
    for repository in fetcher:
        print(repository, flush=True)


# -- REST API (unauthenticated, public repos only) --


def get_all_repositories_rest(user):
    """Fetch public repos via REST API, works for both users and orgs."""
    url = f"https://api.github.com/users/{user}/repos?per_page=100"
    while url:
        request = _rest_request(url)
        try:
            with urlopen(request) as response:
                repos = json.load(response)
                link_header = response.getheader("Link", "")
                url = _parse_next_link(link_header)
        except HTTPError as e:
            if e.code == 404:
                # /users/ endpoint 404s for some orgs, try /orgs/ directly
                yield from _get_org_repositories_rest(user)
                return
            raise
        for repo in repos:
            yield Repository(SimpleNamespace(name=repo["name"], description=repo.get("description")))


def _get_org_repositories_rest(org):
    """Fallback for organizations that don't resolve via /users/."""
    url = f"https://api.github.com/orgs/{org}/repos?per_page=100"
    while url:
        request = _rest_request(url)
        with urlopen(request) as response:
            repos = json.load(response)
            link_header = response.getheader("Link", "")
            url = _parse_next_link(link_header)
        for repo in repos:
            yield Repository(SimpleNamespace(name=repo["name"], description=repo.get("description")))


def _rest_request(url):
    request = Request(url)
    request.add_header("Accept", "application/vnd.github+json")
    return request


def _parse_next_link(link_header):
    """Extract the 'next' page URL from a GitHub Link header."""
    match = re.search(r'<([^>]+)>;\s*rel="next"', link_header)
    return match.group(1) if match else None


# -- GraphQL API (requires authentication) --


GRAPHQL_QUERY_DATA = """{
  repositories(ownerAffiliations: OWNER, first: 30, after: $cursor) {
   nodes {
    name
    description
   }
   pageInfo {
    hasNextPage
    endCursor
   }
  }
}"""
GRAPHQL_QUERY = """query ($user: String!, $cursor: String) {
 user(login: $user) %s
 organization(login: $user) %s
}""" % (
    GRAPHQL_QUERY_DATA,
    GRAPHQL_QUERY_DATA,
)


def get_all_repositories_graphql(user, token):
    """Fetch all visible repos via GraphQL API (authenticated)."""
    query_repos = query_api(GRAPHQL_QUERY, token)
    graph = query_repos({"user": user})
    yield from graph.repos()
    while graph.has_next_page:
        graph = query_repos({"user": user, "cursor": graph.end_cursor})
        yield from graph.repos()


def query_api(query, token):
    def do_query(variables=None):
        data = json.dumps({"query": query, "variables": variables})
        request.add_header("Content-Length", len(data))
        return GraphResponse(fetch(request, data.encode("utf-8")))

    request = Request("https://api.github.com/graphql")
    request.add_header("Content-Type", "application/json; charset=utf-8")
    request.add_header("Authorization", f"token {token}")
    return do_query


def fetch(request, data=None):
    with urlopen(request, data) as stream:
        return json.load(stream, object_hook=lambda o: SimpleNamespace(**o))


# -- Shared domain types --


class Repository:
    def __init__(self, node):
        self.name = node.name
        self.description = node.description

    def __repr__(self):
        if self.description is None:
            return self.name
        return f"{self.name:<30} {self.description[0:89]}"


class GraphResponse:
    def __init__(self, data):
        try:
            self.repositories = data.data.user.repositories
        except TypeError:
            self.repositories = data.data.organization.repositories
        self.has_next_page = self.repositories.pageInfo.hasNextPage
        self.end_cursor = self.repositories.pageInfo.endCursor

    def repos(self):
        yield from map(Repository, self.repositories.nodes)


def parse_args(argv=sys.argv[1:]):
    p = argparse.ArgumentParser(description=__doc__)
    p.add_argument("user", nargs="?", default=os.environ.get("USER"))
    return p.parse_args(argv)


if __name__ == "__main__":
    try:
        sys.exit(main(parse_args()))
    except KeyboardInterrupt:
        print()
